# GPT Apps Integration — ギャップ分析

## 分析サマリー

既存のSubsidyPaymentコードベースとGPT Apps対応要件との間のギャップを分析した結果、以下が判明した：

- **既存APIの再利用性が高い**: サービスディスカバリ、タスク完了、プロキシ実行の主要フローは既存エンドポイントでほぼカバー可能
- **認証・セッション管理が未実装**: 現在のAPIには認証レイヤーが存在せず、GPT Actions用のAPIキー認証を新規追加する必要がある
- **OpenAPIスキーマ・静的ファイル配信が未対応**: `/.well-known/openapi.yaml`、`/privacy` 等の静的エンドポイントが存在しない
- **同意管理（Consent）が未実装**: DBスキーマ・APIともに同意記録の仕組みが存在しない
- **レート制限が未実装**: 429レスポンスやRetry-Afterヘッダーの仕組みがない

---

## 1. 要件別ギャップ詳細

### 要件1: GPT Actions API エンドポイント

| 項目 | 既存状態 | ギャップ | 対応難易度 |
|---|---|---|---|
| OpenAPI 3.1.0 スキーマ | ❌ 未実装 | `/.well-known/openapi.yaml` を新規作成・配信する必要あり | 中 |
| GPTフレンドリーなレスポンス | ⚠️ 部分的 | 既存レスポンスはフラットなJSON構造だが、`description`フィールドの追加やGPT向けの要約フィールドが必要な箇所あり | 低 |
| CORS対応 | ✅ 実装済み | `cors_layer_from_env()` で `chat.openai.com` を含む任意のオリジンを許可可能。現在はデフォルト `*` | なし |
| エンドポイント数制限（30以下） | ✅ 問題なし | 現在18エンドポイント。GPT向けに全て公開する必要はなく、サブセットで十分 | なし |

**既存コード参照**:
- CORS設定: `src/main.rs` L56-84 `cors_layer_from_env()`
- ルーティング: `src/main.rs` L27-54 `build_app()`

---

### 要件2: サービスディスカバリ

| 項目 | 既存状態 | ギャップ | 対応難易度 |
|---|---|---|---|
| キーワード検索 | ⚠️ 部分的 | `/campaigns/discovery` はアクティブキャンペーン一覧を返すが、名前・キーワードによるフィルタリングは未実装 | 低 |
| カテゴリ検索 | ❌ 未実装 | `target_tools` フィールドは存在するが、カテゴリとしての検索APIは未実装 | 低 |
| Sponsored API検索 | ⚠️ 部分的 | `/sponsored-apis` は一覧を返すが、検索・フィルタリングは未実装 | 低 |
| 統合検索エンドポイント | ❌ 未実装 | キャンペーンとSponsored APIを横断的に検索するGPT向け統合エンドポイントが必要 | 中 |

**既存コード参照**:
- キャンペーンディスカバリ: `src/main.rs` L440-475 `list_campaign_discovery()`
- Sponsored API一覧: `src/main.rs` L1026-1063 `list_sponsored_apis()`
- `CampaignDiscoveryItem` 型: `src/types.rs` L282-290

**分析**: 既存の `list_campaign_discovery` と `list_sponsored_apis` をベースに、クエリパラメータ（`q`, `category`）を追加するか、GPT向け統合検索エンドポイントを新設するのが効率的。

---

### 要件3: ユーザー登録・識別

| 項目 | 既存状態 | ギャップ | 対応難易度 |
|---|---|---|---|
| ユーザー登録 | ✅ 実装済み | `/register` および `/profiles` POST で登録可能 | なし |
| 認証（APIキー） | ❌ 未実装 | 現在のAPIには認証レイヤーが一切ない。GPT Actions用のAPIキー認証ミドルウェアを新規追加する必要あり | 中 |
| ソース情報記録 | ❌ 未実装 | `users` テーブルに `source` / `channel` カラムが存在しない | 低 |
| 既存ユーザー検索 | ⚠️ 部分的 | メールアドレスによるユーザー検索エンドポイントが存在しない（IDベースのみ） | 低 |

**既存コード参照**:
- ユーザー登録: `src/main.rs` L237-294 `register_user()`
- UserProfile型: `src/types.rs` L174-184
- usersテーブル: `migrations/0001_init.sql` L1-9

**分析**: 
- `users` テーブルに `source text` カラムを追加するマイグレーションが必要
- GPT Actions認証はAxumのミドルウェアレイヤーで実装可能（`Authorization: Bearer <api_key>` ヘッダー検証）
- メールアドレスによるユーザー検索（`GET /profiles?email=xxx`）を追加するか、GPT向けに「登録 or 既存取得」を1ステップで行う `POST /gpt/auth` エンドポイントを新設

---

### 要件4: タスク実行フロー

| 項目 | 既存状態 | ギャップ | 対応難易度 |
|---|---|---|---|
| タスク完了記録 | ✅ 実装済み | `/tasks/complete` POST でタスク完了を記録 | なし |
| タスク一覧取得 | ⚠️ 部分的 | キャンペーンの `required_task` は単一文字列。タスク一覧を構造化して返すAPIは未実装 | 低 |
| タスク完了状態確認 | ✅ 実装済み | `has_completed_task()` ユーティリティが存在 | なし |
| 同意確認フロー | ❌ 未実装 | タスク完了前の同意確認ロジックが存在しない | 中 |
| タスク入力フォーマット | ❌ 未実装 | タスク種類に応じた入力スキーマの定義・返却が未実装 | 中 |

**既存コード参照**:
- タスク完了: `src/main.rs` L522-596 `complete_task()`
- タスク完了確認: `src/utils.rs` L57-81 `has_completed_task()`
- TaskCompletion型: `src/types.rs` L292-308

**分析**:
- 現在の `required_task` は単一文字列（例: `"survey"`）。GPT向けにはタスクの種類・必要入力項目・説明を構造化して返す必要がある
- 選択肢A: `campaigns` テーブルに `task_schema jsonb` カラムを追加
- 選択肢B: タスクテンプレートを別テーブルで管理
- 選択肢C: GPT向けエンドポイントでハードコードされたタスクテンプレートを返す（MVP向け）

---

### 要件5: 支払い・リソースアクセス

| 項目 | 既存状態 | ギャップ | 対応難易度 |
|---|---|---|---|
| スポンサー決済フロー | ✅ 実装済み | `/proxy/{service}/run` でタスク完了済みユーザーへのスポンサー決済が動作 | なし |
| 支払い記録 | ✅ 実装済み | `payments` テーブルに記録 | なし |
| 予算不足時のフォールバック | ✅ 実装済み | 予算不足時に `payment_required_error` を返す | なし |
| GPT向け統合フロー | ⚠️ 部分的 | 現在は「タスク確認→決済→リソース返却」が複数API呼び出しに分かれている。GPT向けに1ステップで完結するエンドポイントが望ましい | 中 |

**既存コード参照**:
- プロキシ実行: `src/main.rs` L646-907 `run_proxy()`
- Sponsored API実行: `src/main.rs` L1104-1264 `run_sponsored_api()`
- 支払い記録: `migrations/0004_payments.sql`

**分析**: 
- 既存の `run_proxy` は内部でタスク完了確認→スポンサー決済→レスポンス返却を行っており、E2Eフローの核は実装済み
- GPT向けには、このフローの結果をGPTが要約しやすい形式で返すラッパーが必要
- `ServiceRunResponse` 型は既にフラットで、GPTフレンドリー

---

### 要件6: 同意・コンプライアンス

| 項目 | 既存状態 | ギャップ | 対応難易度 |
|---|---|---|---|
| プライバシーポリシーページ | ❌ 未実装 | `/privacy` エンドポイントが存在しない | 低 |
| 同意記録テーブル | ❌ 未実装 | DBに同意管理テーブルが存在しない | 中 |
| 同意取得API | ❌ 未実装 | 同意の記録・確認APIが存在しない | 中 |
| 同意拒否時のフォールバック | ❌ 未実装 | 同意なしでのデータ転送ブロックロジックが未実装 | 中 |

**既存コード参照**: なし（完全に新規）

**分析**: 
- 新規マイグレーション `consents` テーブルが必要（user_id, campaign_id, consent_type, granted, created_at）
- `/consents` POST（同意記録）、`GET /consents?user_id=xxx&campaign_id=yyy`（同意確認）を新設
- タスク完了フローに同意確認ガードを追加

---

### 要件7: GPT構成

| 項目 | 既存状態 | ギャップ | 対応難易度 |
|---|---|---|---|
| システムプロンプト | ❌ 未実装 | 完全に新規作成 | 低（コードではなくドキュメント） |
| Conversation Starters | ❌ 未実装 | 完全に新規作成 | 低 |
| GPT Builder設定 | ❌ 未実装 | ChatGPT UI上での設定作業 | 低 |

**分析**: コード変更は不要。OpenAPIスキーマとシステムプロンプトのドキュメント作成が中心。

---

### 要件8: エラーハンドリング

| 項目 | 既存状態 | ギャップ | 対応難易度 |
|---|---|---|---|
| 構造化エラーレスポンス | ✅ 実装済み | `ApiError` → `ErrorResponse { error: { code, message } }` パターンが全エンドポイントで統一 | なし |
| バリデーションエラー（400） | ✅ 実装済み | `ApiError::validation()` で400を返す | なし |
| 認証エラー（401/403） | ❌ 未実装 | 認証レイヤーが存在しないため、401/403レスポンスが未実装 | 中（認証と同時） |
| レート制限（429） | ❌ 未実装 | レート制限ミドルウェアが存在しない | 中 |
| 内部エラー情報漏洩防止 | ✅ 実装済み | `ApiError::Internal` は一般的なメッセージを返す | なし |

**既存コード参照**:
- エラー型: `src/error.rs` 全体
- `ErrorBody` 構造: `src/error.rs` L19-25

**分析**: 
- エラーレスポンス構造は既にGPTフレンドリー（`{ error: { code, message } }`）
- レート制限は `tower` のミドルウェア（`tower::limit::RateLimitLayer` 等）で追加可能
- 認証エラーは認証ミドルウェア実装時に自然に追加される

---

### 要件9: デプロイ・運用

| 項目 | 既存状態 | ギャップ | 対応難易度 |
|---|---|---|---|
| HTTPS本番URL | ✅ 実装済み | Render上でHTTPSデプロイ済み | なし |
| 環境変数文書化 | ⚠️ 部分的 | `.env.example` は存在するが、GPT Actions用の変数（APIキー等）が未記載 | 低 |
| Prometheusメトリクス統合 | ✅ 実装済み | `Metrics` 構造体で全エンドポイントのリクエスト数を計測 | なし |
| 後方互換性 | ✅ 問題なし | 新規エンドポイント追加のため、既存APIに影響なし | なし |

---

## 2. 既存コンポーネント再利用マップ

| 既存コンポーネント | GPT Apps要件での再利用 | 変更の必要性 |
|---|---|---|
| `list_campaign_discovery()` | 要件2: サービスディスカバリ | クエリパラメータ追加 |
| `complete_task()` | 要件4: タスク実行 | そのまま利用可能 |
| `has_completed_task()` | 要件4: タスク完了確認 | そのまま利用可能 |
| `run_proxy()` | 要件5: 支払い・リソースアクセス | GPT向けラッパー追加 |
| `run_sponsored_api()` | 要件5: Sponsored API実行 | そのまま利用可能 |
| `register_user()` | 要件3: ユーザー登録 | ソースフィールド追加 |
| `ApiError` / `ErrorResponse` | 要件8: エラーハンドリング | そのまま利用可能 |
| `Metrics` | 要件9: メトリクス | ラベル追加のみ |
| `cors_layer_from_env()` | 要件1: CORS | そのまま利用可能 |

---

## 3. 新規実装が必要なコンポーネント

### 3.1 新規エンドポイント

| エンドポイント | 用途 | 優先度 |
|---|---|---|
| `GET /.well-known/openapi.yaml` | OpenAPIスキーマ配信 | P0 |
| `GET /privacy` | プライバシーポリシーページ | P0 |
| `GET /gpt/services` | GPT向け統合サービス検索 | P0 |
| `POST /gpt/auth` | GPT向けユーザー登録/識別 | P0 |
| `GET /gpt/tasks/{campaign_id}` | GPT向けタスク詳細取得 | P0 |
| `POST /gpt/tasks/{campaign_id}/complete` | GPT向けタスク完了（同意込み） | P0 |
| `POST /gpt/services/{service}/run` | GPT向けサービス実行（統合フロー） | P0 |
| `POST /consents` | 同意記録 | P1 |
| `GET /consents` | 同意確認 | P1 |

### 3.2 新規DBマイグレーション

| マイグレーション | 内容 |
|---|---|
| `0007_add_user_source.sql` | `users` テーブルに `source text` カラム追加 |
| `0008_consents.sql` | `consents` テーブル新規作成（user_id, campaign_id, consent_type, granted, purpose, retention_period, created_at） |
| `0009_add_task_schema.sql` | `campaigns` テーブルに `task_schema jsonb` カラム追加（オプション） |

### 3.3 新規ミドルウェア

| ミドルウェア | 内容 |
|---|---|
| APIキー認証 | `Authorization: Bearer <key>` ヘッダー検証。GPT Actionsルートのみに適用 |
| レート制限 | `tower` ベースのレート制限。429 + Retry-After ヘッダー |

### 3.4 新規ファイル（非コード）

| ファイル | 内容 |
|---|---|
| `openapi.yaml` | GPT Actions用OpenAPI 3.1.0スキーマ |
| GPTシステムプロンプト | Custom GPTの指示文書 |
| プライバシーポリシー | HTML/テキストのプライバシーポリシー |

---

## 4. 実装アプローチの選択肢

### アプローチA: 既存エンドポイント拡張（最小変更）

- 既存エンドポイントにクエリパラメータやレスポンスフィールドを追加
- OpenAPIスキーマは既存エンドポイントをそのまま記述
- **メリット**: 変更量が最小、後方互換性が自然に維持
- **デメリット**: GPT向けの最適化が不十分になる可能性

### アプローチB: GPT専用エンドポイント群を新設（推奨）

- `/gpt/*` プレフィックスで GPT Actions 専用エンドポイントを新設
- 内部では既存ロジック（`has_completed_task`, `run_proxy` 等）を再利用
- 認証ミドルウェアは `/gpt/*` ルートのみに適用
- **メリット**: GPT向けに最適化されたレスポンス、既存APIへの影響ゼロ、認証スコープが明確
- **デメリット**: エンドポイント数が増える（ただし30以下は維持可能）

### アプローチC: ハイブリッド

- 一部は既存エンドポイントを拡張（ディスカバリ等）
- 統合フロー（タスク+支払い）のみGPT専用エンドポイントを新設
- **メリット**: バランスが良い
- **デメリット**: どのエンドポイントをどう扱うかの判断が複雑

**推奨**: **アプローチB**。GPT Actionsは独自の認証・レスポンス形式が必要であり、既存APIとの関心の分離が明確になる。

---

## 5. 技術的リスクと要調査事項

| リスク/調査事項 | 詳細 | 影響度 |
|---|---|---|
| GPT Actions認証方式の選定 | APIキー vs OAuth。初期はAPIキーで十分だが、ユーザー識別の粒度に影響 | 高 |
| OpenAPIスキーマのGPT互換性 | GPTがスキーマを正しく解釈するか、実際にGPT Builder上でテストが必要 | 中 |
| レスポンスサイズ制限 | GPT Actionsのレスポンスサイズ上限（約100KB）を超えないか | 低 |
| 同意フローのUX | GPT会話内での同意取得がユーザー体験として自然か | 中 |
| Axumレート制限の実装方法 | `tower::limit` vs カスタムミドルウェア vs 外部サービス（Render側） | 低 |
| `main.rs` の肥大化 | 現在1583行のモノリシック構成。GPTエンドポイント追加でさらに肥大化する | 中（リファクタリング推奨） |

---

## 6. 工数見積もり（概算）

| カテゴリ | 見積もり | 備考 |
|---|---|---|
| OpenAPIスキーマ作成 | 小 | YAMLファイル作成 + 配信エンドポイント |
| GPT専用エンドポイント群 | 中 | 5-7エンドポイント新設（既存ロジック再利用） |
| 認証ミドルウェア | 小〜中 | Axum Extractorベースで実装 |
| 同意管理（DB + API） | 中 | マイグレーション + CRUD API |
| レート制限 | 小 | tower ミドルウェア追加 |
| プライバシーポリシー | 小 | 静的HTMLページ |
| GPTシステムプロンプト | 小 | ドキュメント作成 |
| テスト | 中 | 新規エンドポイントのユニットテスト + GPT Builder上での統合テスト |
| **合計** | **中規模** | 既存ロジックの再利用により、ゼロからの実装よりは大幅に軽量 |
